<!-- ----------------------------------------------------------------------------- 
TEMPLATE DEL PANEL DE ADMINISTRACION DE LA APLICACION
Incluye:
- Menú de usuario con opciones de gestión y cierre de sesión.
- Filtros de búsqueda (editorial y rango de fechas).
- Tabla de resultados con ordenamiento y exportación a CSV.
- Validación en cliente para el rango de fechas.
------------------------------------------------------------------------------->


{% extends "base.html" %}
{% load static %}



{% block title %}Panel ADMIN - Liberalia{% endblock %}

{% block content %}

<div class="container py-3">

  <!-- Logo -->
  <div class="brand-top mb-2">
    <img src="{% static 'img/logo_liberalia.jpg' %}" class="brand-logo" alt="Liberalia">
  </div>

  <!-- Menú usuario (derecha) -->
  <div class="d-flex justify-content-end mb-3">
    <div class="dropdown user-menu">
      <button class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
        {{ request.user.get_username }}
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li class="dropdown-header">
          {{ request.user.email }}<br>
          <span class="badge bg-danger">Administrador</span>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#">Mantenedor usuarios</a></li>
        <li><a class="dropdown-item" href="#">Mantenedor editoriales</a></li>
        <li><a class="dropdown-item" href="{% url 'accounts:password_change' %}">Cambiar contraseña</a></li>
        <li><a class="dropdown-item" href="{% url 'accounts:logout' %}">Cerrar sesión</a></li>
      </ul>
    </div>
  </div>

  <!-- Filtros -->
  <form class="row g-3 align-items-end" method="get" style="max-width:980px;margin:0 auto;">
    <div class="col-12 col-md-5">
      <label class="form-label mb-1">Nombre editorial</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-sliders"></i></span>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar editorial…">
      </div>
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label mb-1">Desde</label>
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control" placeholder="dd-mm-aaaa">
    </div>

    <div class="col-6 col-md-3">
      <label class="form-label mb-1">Hasta</label>
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control" placeholder="dd-mm-aaaa">
    </div>

    <!-- Botones: Descargar al lado de Buscar -->
    <div class="col-12 col-md-1 d-flex gap-2">
      <button class="btn btn-outline-burdeo" type="submit">Buscar</button>
      <a class="btn btn-outline-burdeo"
         href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={{ sort }}&export=csv">
        Descargar
      </a>
    </div>
  </form>

  <!-- Tabla despliegue-->
   

  <div class="table-responsive mt-3" style="max-width:980px; margin:0 auto; min-height: 300px;">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th><a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=isbn">ISBN</a></th>
          <th><a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=titulo">TÍTULO</a></th>
          <th><a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=autor">AUTOR</a></th>
          <th><a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=editorial">EDITORIAL</a></th>
          <th><a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=fecha">F. EDICIÓN</a></th>
          <th class="text-end">Acción</th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr>
          <td class="fw-semibold">{{ r.isbn }}</td>
          <td>{{ r.titulo }}</td>
          <td>{{ r.autor }}</td>
          <td>{{ r.editorial.nombre }}</td>
          <td>{{ r.fecha_edicion|date:"d/m/Y" }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-burdeo disabled">Detalle</a>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="text-center text-muted py-4">Sin resultados</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Valida que la fecha Hasta sea superior a Desde (se puede hacer en el back con Django, posteriormente)-->

<script>
  const form = document.querySelector('form');
  form.addEventListener('submit', function(e) {
    const dateFrom = document.querySelector('input[name="date_from"]').value;
    const dateTo = document.querySelector('input[name="date_to"]').value;

    if (dateFrom && dateTo && dateTo < dateFrom) {
      e.preventDefault();
      alert("La fecha 'Hasta' debe ser igual o posterior a la fecha 'Desde'.");
    }
  });
</script>

{% endblock %}
