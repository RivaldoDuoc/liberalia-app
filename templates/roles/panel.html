<!----------------------------------------------------------------------------- 
PANEL UNIFICADO (ADMIN / CONSULTOR / EDITOR)
- Controla variaciones por rol con variables de contexto:
  is_admin, role_label, role_badge_class,
  can_download, can_create, can_edit, show_detail, detail_disabled,
  create_url_name, edit_url_name.
- Mantiene filtros, tabla, ordenamiento y validación de fechas.
----------------------------------------------------------------------------->
{% extends "base_brand.html" %}
{% load static %}

{% block title %}Panel {{ role_label|default:"USUARIO" }} - Liberalia{% endblock %}

{% block content %}

<div class="container py-3">

  <!-- FILTRO PARA ADMIN Y CONSULTOR (SOLO BUSQUEDA POR EDITORIAL) -------->
  <form class="row g-3 align-items-end" method="get" style="max-width:980px;margin:0 auto;">

    {# --- ADMIN & CONSULTOR: filtro por EDITORIAL --- #}
    {% if not is_editor %}
      <div class="col-12 col-md-5">
        <label class="form-label mb-1">Nombre editorial</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sliders"></i></span>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar editorial…">
        </div>
      </div>
    {% endif %}

    <!-- FILTRO PARA ROL EDITOR - POR TÍTULO E ISBN ------>
    {# --- EDITOR: filtros por TÍTULO e ISBN --- #}
    {% if is_editor %}
      <div class="col-12 col-md-4">
        <label class="form-label mb-1">Título</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sliders"></i></span>
          <input type="text" name="q_titulo" value="{{ q_titulo }}" class="form-control" placeholder="Buscar por título…">
        </div>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label mb-1">ISBN</label>
        <input type="text" name="q_isbn" value="{{ q_isbn }}" class="form-control" placeholder="Buscar por ISBN…">
      </div>
    {% endif %}

    <div class="col-6 col-md-2">
      <label class="form-label mb-1">Desde</label>
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control" placeholder="dd-mm-aaaa">
    </div>

    <div class="col-6 col-md-2">
      <label class="form-label mb-1">Hasta</label>
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control" placeholder="dd-mm-aaaa">
    </div>

    <!-- Botones -->
    <div class="col-12 col-md-1 d-flex gap-2">
      <button class="btn btn-outline-primary" type="submit">Buscar</button>

      {% if can_download %}
        {% if is_editor %}
          <a class="btn btn-outline-primary"
             href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={{ sort }}&export=csv">
            Descargar
          </a>
        {% else %}
          <a class="btn btn-outline-primary"
             href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={{ sort }}&export=csv">
            Descargar
          </a>
        {% endif %}
      {% endif %}

      {% if can_create and create_url_name %}
        <a class="btn btn-outline-primary" href="{% url create_url_name %}">Crear</a>
      {% endif %}
    </div>
  </form>

  <!-- Tabla Desplegada -->
  <div class="table-responsive mt-3" style="max-width:980px; margin:0 auto; min-height: 300px;">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>
            {% if is_editor %}
              <a href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=isbn">ISBN</a>
            {% else %}
              <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=isbn">ISBN</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
              <a href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=titulo">TÍTULO</a>
            {% else %}
              <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=titulo">TÍTULO</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
              <a href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=autor">AUTOR</a>
            {% else %}
              <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=autor">AUTOR</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
              <a href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=editorial">EDITORIAL</a>
            {% else %}
              <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=editorial">EDITORIAL</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
              <a href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=fecha">F. EDICIÓN</a>
            {% else %}
              <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=fecha">F. EDICIÓN</a>
            {% endif %}
          </th>
          <th class="text-end">Acción</th>
        </tr>
      </thead>
      <tbody>
      {% for r in rows %}
        <tr>
          <td class="fw-semibold">{{ r.isbn }}</td>
          <td>{{ r.titulo }}</td>
          <td>{{ r.autor }}</td>
          <td>{{ r.editorial.nombre }}</td>
          <td>{{ r.fecha_edicion|date:"d/m/Y" }}</td>
          <td class="text-end">
            {% if can_edit and edit_url_name %}
              <a class="btn btn-sm btn-outline-primary" href="{% url edit_url_name r.isbn %}">Editar</a>
            {% elif show_detail %}
              <a class="btn btn-sm btn-outline-burdeo {{ detail_disabled|default:'disabled' }}">Detalle</a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="text-center text-muted py-4">Sin resultados</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<script>
  const form = document.querySelector('form');
  //validación de fechas 
  form.addEventListener('submit', function(e) {
    const dateFrom = document.querySelector('input[name="date_from"]').value;
    const dateTo = document.querySelector('input[name="date_to"]').value;
    if (dateFrom && dateTo && dateTo < dateFrom) {
      e.preventDefault();
      alert("La fecha 'Hasta' debe ser igual o posterior a la fecha 'Desde'.");
    }
  });
  //Desplegar vista al limpiar los campos, sin necesidad de ENTER
  // Seleccionamos todos los inputs de tipo texto dentro del formulario
  const inputs = form.querySelectorAll('input[type="text"]');

  inputs.forEach(input => {
    input.addEventListener('input', () => {
      // Si el campo quedó completamente vacío (borrado por el usuario)
      if (input.value === '') {
        // Esperamos 200 milisegundos antes de enviar el formulario
        // Esto ayuda a evitar que se envíe varias veces mientras el usuario escribe
        setTimeout(() => {
          form.submit();
        }, 200);
      }
    });
  });
</script>
{% endblock %}
