<!----------------------------------------------------------------------------- 
PANEL UNIFICADO (ADMIN / CONSULTOR / EDITOR)
- Controla variaciones por rol con variables de contexto:
  is_admin, role_label, role_badge_class,
  can_download, can_create, can_edit, show_detail, detail_disabled,
  create_url_name, edit_url_name.
- Mantiene filtros, tabla, ordenamiento y validación de fechas.
----------------------------------------------------------------------------->
{% extends "base.html" %}
{% load static %}

{% block title %}Panel {{ role_label|default:"USUARIO" }} - Liberalia{% endblock %}

{% block content %}

<style>
  .btn-clear {
    background: none;
    border: none;
    padding: 0;
    color: #6e1423;
    cursor: pointer;
    z-index: 10;
  }

  .btn-clear:hover {
    color: #3e0a14;
  }

  .input-group .form-control {
    padding-right: 1rem;
  }
</style>

<div class="container py-3">

  <!-- FILTRO PARA ADMIN Y CONSULTOR (SOLO BUSQUEDA POR EDITORIAL) -------->
  <form class="row g-3 align-items-end" method="get" style="max-width:980px;margin:0 auto;">

    {# --- ADMIN & CONSULTOR: filtro por EDITORIAL --- #}

    {% if not is_editor %}
    <div class="col-12 col-md-5">
      <label class="form-label mb-1">Nombre editorial</label>
      <div class="input-group position-relative">
        <span class="input-group-text"><i class="bi bi-sliders"></i></span>
        <input type="text" name="q" value="{{ q }}" class="form-control clearable" placeholder="Buscar editorial…">
        <button type="button" class="btn btn-sm btn-clear position-absolute end-0 top-50 translate-middle-y me-2"
          style="display:none;" aria-label="Limpiar campo">
          <i class="bi bi-x-circle small"></i>
        </button>
      </div>
    </div>
    {% endif %}

    <!-- FILTRO PARA ROL EDITOR - POR TÍTULO E ISBN ------>
    {# --- EDITOR: filtros por TÍTULO e ISBN --- #}
    {% if is_editor %}

    <div class="col-12 col-md-4">
      <label class="form-label mb-1">Título</label>
      <div class="input-group position-relative">
        <span class="input-group-text"><i class="bi bi-sliders"></i></span>
        <input type="text" name="q_titulo" value="{{ q_titulo }}" class="form-control clearable"
          placeholder="Buscar por título…">
        <button type="button" class="btn btn-sm btn-clear position-absolute end-0 top-50 translate-middle-y me-2"
          style="display:none;" aria-label="Limpiar campo">
          <i class="bi bi-x-circle small"></i>
        </button>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <label class="form-label mb-1">ISBN</label>
      <div class="input-group position-relative">
        <input type="text" name="q_isbn" value="{{ q_isbn }}" class="form-control clearable"
          placeholder="Buscar por ISBN…">
        <button type="button" class="btn btn-sm btn-clear position-absolute end-0 top-50 translate-middle-y me-2"
          style="display:none;" aria-label="Limpiar campo">
          <i class="bi bi-x-circle small"></i>
        </button>
      </div>
    </div>

    {% endif %}

    <div class="col-6 col-md-2">
      <label class="form-label mb-1">Desde</label>
      <div class="input-group position-relative">
        <input type="date" name="date_from" value="{{ date_from }}" class="form-control clearable"
          placeholder="dd-mm-aaaa">
        <button type="button" class="btn btn-sm btn-clear position-absolute end-0 top-50 translate-middle-y me-2"
          style="display:none;" aria-label="Limpiar campo">
          <i class="bi bi-x-circle small"></i>
        </button>
      </div>
    </div>


    <div class="col-6 col-md-2">
      <label class="form-label mb-1">Hasta</label>
      <div class="input-group position-relative">
        <input type="date" name="date_to" value="{{ date_to }}" class="form-control clearable" placeholder="dd-mm-aaaa">
        <button type="button" class="btn btn-sm btn-clear position-absolute end-0 top-50 translate-middle-y me-2"
          style="display:none;" aria-label="Limpiar campo">
          <i class="bi bi-x-circle small"></i>
        </button>
      </div>
    </div>


    <!-- Botones -->
    <div class="col-12 col-md-1 d-flex gap-2">
      <button class="btn btn-outline-primary" type="submit">Buscar</button>

      {% if can_download %}
      {% if is_editor %}
      <a class="btn btn-outline-primary"
        href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={{ sort }}&export=csv">
        Descargar
      </a>
      {% else %}
      <a class="btn btn-outline-primary"
        href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort={{ sort }}&export=csv">
        Descargar
      </a>
      {% endif %}
      {% endif %}

      {% if can_create and create_url_name %}
      <a class="btn btn-outline-primary" href="{% url create_url_name %}">Crear</a>
      {% endif %}
    </div>
  </form>

  <!-- Tabla Desplegada -->
  <div class="table-responsive mt-3" style="max-width:980px; margin:0 auto; min-height: 300px;">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>
            {% if is_editor %}
            <a
              href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=isbn">ISBN</a>
            {% else %}
            <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=isbn">ISBN</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
            <a
              href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=titulo">TÍTULO</a>
            {% else %}
            <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=titulo">TÍTULO</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
            <a
              href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=autor">AUTOR</a>
            {% else %}
            <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=autor">AUTOR</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
            <a
              href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=editorial">EDITORIAL</a>
            {% else %}
            <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=editorial">EDITORIAL</a>
            {% endif %}
          </th>
          <th>
            {% if is_editor %}
            <a
              href="?q_titulo={{ q_titulo }}&q_isbn={{ q_isbn }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=fecha">F.
              EDICIÓN</a>
            {% else %}
            <a href="?q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}&sort=fecha">F. EDICIÓN</a>
            {% endif %}
          </th>
          <th class="text-end">Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td class="fw-semibold">{{ r.isbn }}</td>
          <td>{{ r.titulo }}</td>
          <td>{{ r.autor }}</td>
          <td>{{ r.editorial.nombre }}</td>
          <td>{{ r.fecha_edicion|date:"d/m/Y" }}</td>
          <td class="text-end">
            {% if can_edit and edit_url_name %}
            <a class="btn btn-sm btn-outline-primary" href="{% url edit_url_name r.isbn %}">Editar</a>
            {% elif show_detail %}
            <!--<a href="{% url 'catalogo:libro_detalle' r.isbn %}" class="btn btn-sm btn-outline-burdeo {{ detail_disabled|default:'disabled' }}">Detalle</a>-->
            <a class="btn btn-sm btn-outline-burdeo" href="{% url 'catalogo:libro_detalle' r.isbn %}">Detalle</a>
            {% else %}
            <span class="text-muted">—</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">Sin resultados</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!--PAGINACION (8 REGISTROS POR)-->
  {% if is_paginated %}
  <nav aria-label="Paginación" class="d-flex justify-content-center mt-3">
    <ul class="pagination mb-0">

      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
          href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
      {% endif %}

      {% for num in paginator.page_range %}
      {% if page_obj.number == num %}
      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %} <li class="page-item">
        <a class="page-link" href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ num }}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
        {% endif %}

    </ul>
  </nav>
  {% endif %}
</div>

<script>
  const form = document.querySelector('form');
  //validación de fechas 
  form.addEventListener('submit', function (e) {
    const dateFrom = document.querySelector('input[name="date_from"]').value;
    const dateTo = document.querySelector('input[name="date_to"]').value;
    if (dateFrom && dateTo && dateTo < dateFrom) {
      e.preventDefault();
      alert("La fecha 'Hasta' debe ser igual o posterior a la fecha 'Desde'.");
    }
  });
  //Desplegar vista al limpiar los campos, sin necesidad de ENTER
  // Seleccionamos todos los inputs de tipo texto dentro del formulario
  const inputs = form.querySelectorAll('input[type="text"]');

  inputs.forEach(input => {
    input.addEventListener('input', () => {
      // Si el campo quedó completamente vacío (borrado por el usuario)
      if (input.value === '') {
        // Esperamos 200 milisegundos antes de enviar el formulario
        // Esto ayuda a evitar que se envíe varias veces mientras el usuario escribe
        setTimeout(() => {
          form.submit();
        }, 200);
      }
    });
  });

  document.querySelectorAll('.clearable').forEach(input => {
    const clearBtn = input.parentElement.querySelector('.btn-clear');
    const toggleClearBtn = () => {
      if (input.value) {
        clearBtn.style.display = 'block';
      } else {
        clearBtn.style.display = 'none';
      }
    };

    input.addEventListener('input', toggleClearBtn);
    toggleClearBtn(); // mostrar u ocultar al cargar

    clearBtn.addEventListener('click', () => {
      input.value = '';
      toggleClearBtn();
      form.submit();
    });
  });



</script>
{% endblock %}