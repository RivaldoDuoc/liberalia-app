{% extends "base.html" %}
{% load static %}
{% block title %} Mantenedor de Editoriales {% endblock %}
{% block content %}

<div class="container py-4" style="max-width:1100px;">

    <h2 class="mb-3 fw-semibold text-center">Mantenedor de Editoriales</h2>

    <!-- Filtros de búsqueda (nombre e ID fiscal) -->
    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-12 col-md-5">
            <label class="form-label mb-1">Buscar Editorial</label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-list"></i></span>
                    <input id="q_nombre" type="text" name="q_nombre" value="{{ q_nombre|default:'' }}"
                        class="form-control" placeholder="Filtrar por nombre de editorial">
                    <button class="btn btn-outline-primary" type="submit" title="Buscar">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <!-- Botón X para limpiar el campo y re-ejecutar el filtro -->
                <button type="button" class="btn btn-link input-clear-btn visually-hidden" data-target="#q_nombre"
                    title="Limpiar">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>

        <div class="col-12 col-md-5">
            <label class="form-label mb-1">ID Fiscal</label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-list"></i></span>
                    <input id="q_idfiscal" type="text" name="q_idfiscal" value="{{ q_idfiscal|default:'' }}"
                        class="form-control" placeholder="Filtrar por ID Fiscal">
                    <button class="btn btn-outline-primary" type="submit" title="Buscar">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <!-- Botón X para limpiar el campo y re-ejecutar el filtro -->
                <button type="button" class="btn btn-link input-clear-btn visually-hidden" data-target="#q_idfiscal"
                    title="Limpiar">
                    <i class="bi bi-x-circle"></i>
                </button>
            </div>
        </div>

        <!-- Espacio reservado por consistencia visual -->
        <div class="col-12 col-md-2 text-md-end">
            <label class="form-label mb-1 d-none d-md-block">&nbsp;</label>
            <div class="w-100"></div>
        </div>

<!-- Filtro por estado: más pequeños, alineado a la izquierda -->
<div class="col-12">
  <div class="btn-group" role="group" aria-label="Filtro de estado">

    <input type="radio" class="btn-check" name="estado" id="est-all" value="all"
           {% if estado == 'all' %}checked{% endif %}>
    <label class="btn btn-outline-primary btn-sm py-0 px-2 {% if estado == 'all' %}fw-bold{% endif %}" for="est-all">
      Todas
    </label>

    <input type="radio" class="btn-check" name="estado" id="est-active" value="active"
           {% if estado == 'active' %}checked{% endif %}>
    <label class="btn btn-outline-primary btn-sm py-0 px-2 {% if estado == 'active' %}fw-bold{% endif %}" for="est-active">
      Activas
    </label>

    <input type="radio" class="btn-check" name="estado" id="est-inactive" value="inactive"
           {% if estado == 'inactive' %}checked{% endif %}>
    <label class="btn btn-outline-primary btn-sm py-0 px-2 {% if estado == 'inactive' %}fw-bold{% endif %}" for="est-inactive">
      Inactivas
    </label>

  </div>
</div>



    </form>

    <!-- Listado de editoriales -->
    <div class="table-responsive">
        <table class="table align-middle">
            <thead class="table-light thead-brand">
                <tr>
                    <th>Id</th>
                    <th>Nombre</th>
                    <th>Id_Fiscal</th>
                    <th>Cargos</th>
                    <th>Gastos Ind.</th>
                    <th>Fletes e Int.</th>
                    <th>Margen</th>
                    <th>Usuarios</th>
                    <th class="text-end">Acción</th>
                </tr>
            </thead>
            <tbody>
                {% if editoriales %}
                {% for ed in editoriales %}
                {% with rels=ed.usuarioeditorial_set.all %}
                <tr class="{% if not ed.is_active %}editorial-inactiva{% endif %}">
                    <td>{{ ed.id }}</td>
                    <td>
                        {{ ed.nombre|default:"—" }}
                        {% if not ed.is_active %}
                        <span class="badge badge-inactivo ms-2">Editorial Inactiva</span>
                        {% endif %}
                    </td>
                    <td>{{ ed.id_fiscal|default:"—" }}</td>
                    <td class="text-center">{{ ed.cargo_origen|floatformat:2 }}%</td>
                    <td class="text-center">{{ ed.gastos_indirectos|floatformat:2 }}%</td>
                    <td class="text-center">{{ ed.recargo_fletes|floatformat:2 }}%</td>
                    <td class="text-center">{{ ed.margen_comercializacion|floatformat:2 }}%</td>
                    <td>
                        {% if rels and rels.count %}
                        {% for rel in rels %}
                        {{ rel.user.email|default:"—" }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <div class="d-flex justify-content-end gap-2">
                            <!-- Botón EDITAR (deshabilitado si la editorial está inactiva) -->
                            <button class="btn btn-outline-primary btn-sm btn-editar" type="button" title="Editar"
                                data-editorial-id="{{ ed.id }}" data-nombre="{{ ed.nombre|default:'' }}"
                                data-idfiscal="{{ ed.id_fiscal|default:'' }}"
                                data-cargo="{{ ed.cargo_origen|floatformat:2 }}"
                                data-gastos="{{ ed.gastos_indirectos|floatformat:2 }}"
                                data-fletes="{{ ed.recargo_fletes|floatformat:2 }}"
                                data-margen="{{ ed.margen_comercializacion|floatformat:2 }}" data-bs-toggle="modal"
                                data-bs-target="#modalEditarEditorial" {% if not ed.is_active %}disabled
                                aria-disabled="true" {% endif %}>
                                Editar
                            </button>

                            <!-- Botón Habilitar/Deshabilitar (texto y estado dinámicos) -->
                            <button class="btn btn-outline-primary btn-sm btn-toggle-estado" type="button"
                                title="{% if ed.is_active %}Deshabilitar{% else %}Habilitar{% endif %}"
                                data-editorial-id="{{ ed.id }}" data-nombre="{{ ed.nombre|default:'' }}"
                                data-activo="{% if ed.is_active %}1{% else %}0{% endif %}" data-bs-toggle="modal"
                                data-bs-target="#modalConfirmToggleEditorial">
                                {% if ed.is_active %}Deshabilitar{% else %}Habilitar{% endif %}
                            </button>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-4">Sin resultados</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Paginación estilo panel.html -->
    {% if is_paginated %}
    <nav aria-label="Paginación" class="d-flex justify-content-center mt-3">
        <ul class="pagination mb-0">

            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link"
                    href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.previous_page_number }}">&laquo;</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %} <li class="page-item">
                <a class="page-link" href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                        href="?{% if base_qs %}{{ base_qs }}&{% endif %}page={{ page_obj.next_page_number }}">&raquo;</a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}

        </ul>
    </nav>
    {% endif %}
</div>

<script>
    // Mostrar/ocultar botón "X" en inputs según tenga texto y limpiar + enviar
    document.querySelectorAll('.input-clear-btn').forEach(btn => {
        const input = document.querySelector(btn.dataset.target);
        if (!input) return;
        const updateVisibility = () => btn.classList.toggle('visually-hidden', !input.value.trim());
        input.addEventListener('input', updateVisibility);
        updateVisibility();
        btn.addEventListener('click', () => { input.value = ''; input.form.submit(); });
    });

    // Auto-submit al cambiar el filtro de estado
    document.querySelectorAll('input[name="estado"]').forEach(r => {
        r.addEventListener('change', () => r.form.submit());
    });
</script>


<!-- Modal: Editar Editorial -->
<div class="modal fade" id="modalEditarEditorial" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-editar">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar Editorial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="alert d-none" id="editarEditorialAlert"></div>

                <form id="formEditarEditorial">
                    {% csrf_token %}
                    <input type="hidden" id="ed-id">

                    <div class="mb-2">
                        <label class="form-label">Nombre Editorial</label>
                        <input id="ed-nombre" type="text" class="form-control" maxlength="150" required>
                        <div class="invalid-feedback" data-for="nombre"></div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">ID Fiscal</label>
                        <input id="ed-idfiscal" type="text" class="form-control" maxlength="50">
                        <div class="invalid-feedback" data-for="id_fiscal"></div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Cargo en Origen (%)</label>
                            <input id="ed-cargo" type="number" step="0.01" min="0" max="100" class="form-control">
                            <div class="invalid-feedback" data-for="cargo_origen"></div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Gastos Indirectos (%)</label>
                            <input id="ed-gastos" type="number" step="0.01" min="0" max="100" class="form-control">
                            <div class="invalid-feedback" data-for="gastos_indirectos"></div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Fletes e Internación (%)</label>
                            <input id="ed-fletes" type="number" step="0.01" min="0" max="100" class="form-control">
                            <div class="invalid-feedback" data-for="recargo_fletes"></div>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Margen de Comercialización (%)</label>
                            <input id="ed-margen" type="number" step="0.01" min="0" max="100" class="form-control">
                            <div class="invalid-feedback" data-for="margen_comercializacion"></div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-outline-primary btn-sm" id="btnGuardarEditorial" type="button">Guardar</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Confirmar guardado -->
<div class="modal fade" id="modalConfirmarGuardarEditorial" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-confirmar">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Confirmar cambios</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body text-center">
                ¿Deseas guardar los cambios?
            </div>

            <div class="modal-footer justify-content-center">
                <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarGuardarEditorial" class="btn btn-outline-primary btn-sm"
                    type="button">Guardar</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal: Confirmar habilitar/deshabilitar -->
<div class="modal fade" id="modalConfirmToggleEditorial" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-confirmar">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmToggleEditorialTitle">Confirmar acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-center" id="modalConfirmToggleEditorialMsg">
                <!-- Mensaje desde JS: “¿Seguro que desea (des)habilitar la editorial “Nombre”?” -->
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                <button id="btnConfirmarToggleEditorial" class="btn btn-outline-primary btn-sm"
                    type="button">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.EDITORIALES_EDIT_URL_PATTERN = "{% url 'roles:editoriales_editar' 0 %}".replace('/0/', '/__ID__/');
    window.EDITORIALES_TOGGLE_URL_PATTERN = "{% url 'roles:editoriales_toggle' 0 %}".replace('/0/', '/__ID__/');
</script>
<script src="{% static 'js/editoriales_editar.js' %}?v=2"></script>
<script src="{% static 'js/editoriales_toggle.js' %}?v=1"></script>

{% endblock %}