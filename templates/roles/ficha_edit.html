{% extends "base.html" %}
{% load static %}
{% block title %}Editar — Libro{% endblock %}

{% block content %}
<style>
  :root{--bg:#f6f7f9;--card:#fff;--text:#1f2937;--muted:#6b7280;--input:#e5e7eb;--radius:20px}
  *{box-sizing:border-box}
  body{background:var(--bg)}
  h1{margin:6px 0 18px;text-align:center;font-size:32px}
  .card-slim{
    max-width:860px;margin:0 auto;background:var(--card);border-radius:var(--radius);
    padding:32px 24px;box-shadow:0 1px 2px rgba(16,24,40,.04), 0 10px 15px rgba(16,24,40,.08)
  }
  .section-title{margin:6px 0 18px;text-align:center;font-weight:600;color:var(--muted);letter-spacing:.02em}
  .form-grid{max-width:720px;margin:0 auto;display:grid;gap:14px}
  @media (min-width: 720px){
    .grid-2{grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{grid-template-columns:repeat(3,1fr);gap:16px}
    .grid-4{grid-template-columns:repeat(4,1fr);gap:16px}
  }
  label{display:block;margin:0 0 6px;font-size:12px;color:var(--muted)}
  input, select, textarea{
    width:100%; padding:10px 12px; border:1px solid var(--input); border-radius:8px;
    background:#fafafa; outline:0; font-size:14px;
  }
  input:focus, select:focus, textarea:focus{
    border-color:#94a3b8; background:#fff; box-shadow:0 0 0 3px rgba(59,130,246,.12)
  }
  .divider{height:1px;background:#e5e7eb;margin:24px auto;max-width:720px}
  .footer-note{margin:8px 0 0;text-align:center;font-weight:600}
  .error{color:#b91c1c;font-size:12px;margin-top:4px}
  .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
  .btn{padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer}
  .btn-outline{border:1px solid #ccc;background:#fff}
  .btn-primary{border:0;background:#2563eb;color:#fff}
</style>

<div class="container py-3">
  <h1>Editar</h1>

  <div class="card-slim">
    <form method="post" class="form-grid" novalidate>
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.GET.next }}">

      {% if form.non_field_errors %}
        <div class="error">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- Identificación -->
      <h2 class="section-title">Identificación del libro</h2>
      <div class="grid-2">
        <div>
          <label for="{{ form.isbn.id_for_label }}">ISBN</label>
          {{ form.isbn }}
          {% if form.isbn.errors %}<div class="error">{{ form.isbn.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.ean.id_for_label }}">EAN-13</label>
          {{ form.ean }}
          {% if form.ean.errors %}<div class="error">{{ form.ean.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="{{ form.titulo.id_for_label }}">Título original</label>
          {{ form.titulo }}
          {% if form.titulo.errors %}<div class="error">{{ form.titulo.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.subtitulo.id_for_label }}">Subtítulo</label>
          {{ form.subtitulo }}
          {% if form.subtitulo.errors %}<div class="error">{{ form.subtitulo.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="grid-3">
        <div>
          <label for="{{ form.autor.id_for_label }}">Autor(es)</label>
          {{ form.autor }}
          {% if form.autor.errors %}<div class="error">{{ form.autor.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.autor_prologo.id_for_label }}">Prólogo</label>
          {{ form.autor_prologo }}
          {% if form.autor_prologo.errors %}<div class="error">{{ form.autor_prologo.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.traductor.id_for_label }}">Traductor(es)</label>
          {{ form.traductor }}
          {% if form.traductor.errors %}<div class="error">{{ form.traductor.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div>
        <label for="{{ form.ilustrador.id_for_label }}">Ilustrador(es)</label>
        {{ form.ilustrador }}
        {% if form.ilustrador.errors %}<div class="error">{{ form.ilustrador.errors|striptags }}</div>{% endif %}
      </div>

      <div class="divider"></div>
      <p class="footer-note">Ficha técnica</p>
      <div class="grid-3">
        <div>
          <label for="{{ form.tipo_tapa.id_for_label }}">Encuadernación</label>
          {{ form.tipo_tapa }}
          {% if form.tipo_tapa.errors %}<div class="error">{{ form.tipo_tapa.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.numero_paginas.id_for_label }}">Páginas</label>
          {{ form.numero_paginas }}
          {% if form.numero_paginas.errors %}<div class="error">{{ form.numero_paginas.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.idioma_original.id_for_label }}">Idioma</label>
          {{ form.idioma_original }}
          {% if form.idioma_original.errors %}<div class="error">{{ form.idioma_original.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="grid-4">
        <div>
          <label for="{{ form.alto_cm.id_for_label }}">Alto (cm)</label>
          {{ form.alto_cm }}
          {% if form.alto_cm.errors %}<div class="error">{{ form.alto_cm.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.ancho_cm.id_for_label }}">Ancho (cm)</label>
          {{ form.ancho_cm }}
          {% if form.ancho_cm.errors %}<div class="error">{{ form.ancho_cm.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.grosor_cm.id_for_label }}">Grosor (cm)</label>
          {{ form.grosor_cm }}
          {% if form.grosor_cm.errors %}<div class="error">{{ form.grosor_cm.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.peso_gr.id_for_label }}">Peso (gr)</label>
          {{ form.peso_gr }}
          {% if form.peso_gr.errors %}<div class="error">{{ form.peso_gr.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="divider"></div>
      <p class="footer-note">Editorial y edición</p>
      <div class="grid-2">
        <div>
          <label for="{{ form.editorial.id_for_label }}">Editorial</label>
          {{ form.editorial }}
          {% if form.editorial.errors %}<div class="error">{{ form.editorial.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.numero_edicion.id_for_label }}">Nº edición</label>
          {{ form.numero_edicion }}
          {% if form.numero_edicion.errors %}<div class="error">{{ form.numero_edicion.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="{{ form.fecha_edicion.id_for_label }}">Fecha edición</label>
          {{ form.fecha_edicion }}
          {% if form.fecha_edicion.errors %}<div class="error">{{ form.fecha_edicion.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.pais_edicion.id_for_label }}">País</label>
          {{ form.pais_edicion }}
          {% if form.pais_edicion.errors %}<div class="error">{{ form.pais_edicion.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="{{ form.numero_impresion.id_for_label }}">Nº impresión</label>
          {{ form.numero_impresion }}
          {% if form.numero_impresion.errors %}<div class="error">{{ form.numero_impresion.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.tematica.id_for_label }}">Temática</label>
          {{ form.tematica }}
          {% if form.tematica.errors %}<div class="error">{{ form.tematica.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="divider"></div>
      <p class="footer-note">Comercial</p>
      <div class="grid-3">
        <div>
          <label for="{{ form.precio.id_for_label }}">Precio sin IVA</label>
          {{ form.precio }}
          {% if form.precio.errors %}<div class="error">{{ form.precio.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.moneda.id_for_label }}">Moneda</label>
          {{ form.moneda }}
          {% if form.moneda.errors %}<div class="error">{{ form.moneda.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.descuento_distribuidor.id_for_label }}">Descuento (%)</label>
          {{ form.descuento_distribuidor }}
          {% if form.descuento_distribuidor.errors %}<div class="error">{{ form.descuento_distribuidor.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div>
        <label for="{{ form.resumen_libro.id_for_label }}">Resumen</label>
        {{ form.resumen_libro }}
        {% if form.resumen_libro.errors %}<div class="error">{{ form.resumen_libro.errors|striptags }}</div>{% endif %}
      </div>

      <div class="grid-2">
        <div>
          <label for="id_codigo_imagen">Portada actual / Reemplazar</label>
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:100px;height:140px;flex:0 0 auto;border:1px solid #e5e7eb;padding:4px;display:flex;align-items:center;justify-content:center;background:#fafafa;">
              {% if ficha.codigo_imagen %}
                <img id="currentPortada" src="{% static 'media/' %}{{ ficha.codigo_imagen }}" alt="Portada" style="max-width:100%;max-height:100%;object-fit:contain;" />
              {% elif ficha.portada %}
                <img id="currentPortada" src="{{ ficha.portada.url }}" alt="Portada" style="max-width:100%;max-height:100%;object-fit:contain;" />
              {% else %}
                <img id="currentPortada" src="{% static 'img/cover.jpeg' %}" alt="Portada" style="max-width:100%;max-height:100%;object-fit:contain;" />
              {% endif %}
            </div>

            <div style="flex:1 1 auto;">
              <input type="file" id="replacePortadaInput" accept=".png,.jpg,.jpeg,image/png,image/jpeg">
              <div id="fileReplaceStatus" class="text-muted" style="font-size:13px;margin-top:6px;">Selecciona un archivo para reemplazar la portada (se subirá al guardar).</div>
            </div>
          </div>

          {# Mantener el campo real como hidden; el JS actualizará su valor antes de submit #}
          <input type="hidden" name="{{ form.codigo_imagen.name }}" id="id_codigo_imagen" value="{{ form.codigo_imagen.value|default:'' }}">
          {% if form.codigo_imagen.errors %}<div class="error">{{ form.codigo_imagen.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label for="{{ form.rango_etario.id_for_label }}">Rango etario</label>
          {{ form.rango_etario }}
          {% if form.rango_etario.errors %}<div class="error">{{ form.rango_etario.errors|striptags }}</div>{% endif %}
        </div>
      </div>

      <div class="actions">

        {# Botón que abre el modal de confirmación #}
        <button type="button"
          class="btn btn-danger btn-sm"
          style="margin-right:auto"
          data-bs-toggle="modal"
          data-bs-target="#confirmDeleteModal">
          Eliminar ficha
        </button>
        <a href="{% url 'roles:panel' %}" class="btn btn-outline">Volver</a>
        <button type="submit" class="btn btn-primary">Guardar</button>

        



        
      </div>
    </form>
  </div>
</div>


{% include "roles/confirm_delete_modal.html" %}

{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const fileInput = document.getElementById('replacePortadaInput');
    const statusEl = document.getElementById('fileReplaceStatus');
    const previewImg = document.getElementById('currentPortada');
    const codigoInput = document.getElementById('id_codigo_imagen');
    const form = document.querySelector('.card-slim form');
    if (!fileInput || !form) return;

    // CSRF cookie reader
    function getCookie(name){
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrfToken = getCookie('csrftoken');
    const uploadUrl = "{% url 'roles:upload_portada' %}";

    let pendingFile = null;

    fileInput.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      pendingFile = f;
      statusEl.textContent = 'Preparado para subir (se guardará al presionar Guardar)';

      const reader = new FileReader();
      reader.onload = function(e){
        previewImg.src = e.target.result;
      };
      reader.readAsDataURL(f);
    });

    form.addEventListener('submit', async function(ev){
      if (!pendingFile) return; // nothing to do
      ev.preventDefault();
      statusEl.textContent = 'Subiendo...';

      try{
        const fd = new FormData();
        fd.append('portada', pendingFile);
        const resp = await fetch(uploadUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrfToken },
          body: fd,
          credentials: 'same-origin'
        });
        if (!resp.ok) throw new Error('Error de red: ' + resp.status);
        const data = await resp.json();
        if (!(data && data.success)) throw new Error((data && data.error) ? data.error : 'Error al subir');

        codigoInput.value = data.codigo_imagen || data.filename || '';
        statusEl.textContent = 'Subido. Guardando...';
        form.submit();
      }catch(err){
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.classList.add('text-danger');
      }
    });
  })();
</script>
{% endblock %}
